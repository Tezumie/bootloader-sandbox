(()=>{if(window.__BootloaderSandboxInit)return;window.__BootloaderSandboxInit=!0;const e=window.BootloaderSandboxConfig||{},t=!1!==e.cache,n="bldr_seed",a="bldr_iter",r="http://www.w3.org/2000/svg",o='\n:root{\n  /* Light theme (default) */\n  --fg:#111; --bg:#fff; --muted:#666; --border:#111;\n  --btn-bg:#fff; --btn-bg-hover:#f3f3f3; --btn-bg-active:#e9e9e9;\n  --input-bg:#fff;\n  --veil:rgba(255,255,255,0.6);\n  --focus:#111;\n}\n:root[data-theme="dark"]{\n  --fg:#eee; --bg:#111; --muted:#aaa; --border:#333;\n  --btn-bg:#1b1b1b; --btn-bg-hover:#222; --btn-bg-active:#262626;\n  --input-bg:#0f0f0f;\n  --veil:rgba(255,255,255,0.3);\n  --focus:#eee;\n}\n\n*{box-sizing:border-box} html,body{height:100%}\nbody{\n  margin:0; background:var(--bg); display:flex; flex-direction:column;\n  font-family:"IBM Plex Mono", monospace; font-size:14px;\n}\n\n/* Header */\n.head{\n  background:var(--bg); color:var(--fg); border-bottom:1px solid var(--border);\n  margin:0; padding:8px 10px; display:flex; align-items:center; gap:12px; user-select:none;\n}\n.head .title{ font-weight:500; letter-spacing:.02em; margin-right:auto; }\n.head .label{ color:var(--muted); margin-left:6px; margin-right:4px; }\n\n/* Inputs */\n.head .input{\n  height:24px; padding:2px 6px; font:inherit; color:var(--fg);\n  background:var(--input-bg); border:1px solid var(--border); width:90px; padding-right:22px;\n}\n.head #iter{ width:64px; }\n.head .input:focus{ outline:1px solid var(--focus); outline-offset:-1px; }\n\n.input-wrap{ position:relative; display:inline-flex; align-items:center; }\n.clearbtn{\n  position:absolute; right:6px; top:calc(50% - 6px); transform:translateY(-50%);\n  width:16px; height:16px; line-height:16px; border:0; background:transparent; color:var(--muted);\n  cursor:pointer; padding:0; font:22px/1 "IBM Plex Mono", monospace; opacity:0; pointer-events:none;\n}\n.input-wrap:focus-within.has-value .clearbtn{ opacity:1; pointer-events:auto; }\n.clearbtn:hover{ color:var(--fg); }\n\n/* Header buttons */\n.head .iconbtn{\n  width:28px; height:28px; padding:0; display:inline-grid; place-items:center;\n  background:var(--btn-bg); color:var(--fg); border:1px solid var(--border); cursor:pointer;\n}\n.head .iconbtn:hover{ background:var(--btn-bg-hover); }\n.head .iconbtn:active{ background:var(--btn-bg-active); }\n.head .icon{\n  width:16px; height:16px; stroke:currentColor; fill:none; stroke-width:2; vector-effect:non-scaling-stroke;\n}\n\n/* Stage */\n#stage-wrap{ position:relative; flex:1; min-height:0; margin:0; background:var(--bg); }\n#stage-mask{\n  position:absolute; inset:0; background:var(--veil);\n  opacity:0; pointer-events:none;\n}\n#stage-wrap.is-loading #stage-mask{ opacity:1; }\n#stage{ width:100%; height:100%; display:block; background:transparent; overflow:hidden; }\n#stage > svg{ width:100%; height:100%; display:block; }\n  '.trim();function i(){return t?{seed:localStorage.getItem(n),iter:localStorage.getItem(a)}:{seed:null,iter:null}}function l(e,r){t&&(null!=e&&localStorage.setItem(n,String(e)),null!=r&&localStorage.setItem(a,String(r)))}function s(e){const t=e.closest(".input-wrap");t&&(e.value&&String(e.value).length?t.classList.add("has-value"):t.classList.remove("has-value"))}async function c(){const t="string"==typeof e.source&&e.source.trim()?e.source.trim():"sketch.js";try{const e=await fetch(t,{cache:"no-store"});if(!e.ok)throw new Error(String(e.status));return await e.text()}catch{const e="script.js",n=await fetch(e,{cache:"no-store"});if(!n.ok)throw new Error(`Failed to fetch source: ${t} AND ${e}`);return await n.text()}}function d(e){const t=document.createElement("template");return t.innerHTML=e.trim(),t.content.firstElementChild}function u(){!function(){const t=e&&e.theme||"light",n=document.documentElement;"dark"===t?n.setAttribute("data-theme","dark"):n.removeAttribute("data-theme")}(),function(){if(!document.querySelector('link[href*="IBM+Plex+Mono"]')){const e=document.createElement("link");e.rel="stylesheet",e.href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600;700&display=swap",document.head.appendChild(e)}}(),function(){const e=document.createElement("style");e.textContent=o,document.head.appendChild(e)}();const u=document.querySelector("main")||document.body,p=d('\n      <div class="head" role="toolbar" aria-label="Live Preview controls">\n        <div class="title">Live Preview</div>\n\n        <div class="label">iteration:</div>\n        <span class="input-wrap">\n          <input id="iter" class="input" type="text" value="0" min="0" />\n          <button type="button" class="clearbtn" data-target="iter" aria-label="Clear iteration">×</button>\n        </span>\n\n        <div class="label">seed:</div>\n        <span class="input-wrap">\n          <input id="seed" class="input" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="6" value="0" title="6-digit numeric seed (e.g. 894188)" />\n          <button type="button" class="clearbtn" data-target="seed" aria-label="Clear seed">×</button>\n        </span>\n\n        <button id="randomSeed" class="iconbtn" title="Randomize seed">\n          <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">\n            <rect width="12" height="12" x="2" y="10" rx="2" ry="2"></rect>\n            <path d="m17.92 14 3.5-3.5a2.24 2.24 0 0 0 0-3l-5-4.92a2.24 2.24 0 0 0-3 0L10 6"></path>\n            <path d="M6 18h.01"></path>\n            <path d="M18 9h.01"></path>\n            <path d="M10 14h.01"></path>\n            <path d="M15 6h.01"></path>\n          </svg>\n        </button>\n\n        <button id="reload" class="iconbtn" title="Refresh preview">\n          <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">\n            <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>\n            <path d="M21 3v5h-5"></path>\n            <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>\n            <path d="M8 16H3v5"></path>\n          </svg>\n        </button>\n      </div>\n    '),f=d('\n      <div id="stage-wrap">\n        <div id="stage" role="img" aria-label="Preview Area"></div>\n        <div id="stage-mask" aria-hidden="true"></div>\n      </div>\n    ');u.prepend(f),u.prepend(p);const g=p.querySelector("#seed"),h=p.querySelector("#iter"),v=p.querySelector("#reload"),b=p.querySelector("#randomSeed"),m=f.querySelector("#stage"),x=new URLSearchParams(location.search),w=()=>f.classList.remove("is-loading");if(x.has("seed"))g.value=x.get("seed");else{const{seed:e}=i();e&&(g.value=e)}if(x.has("iter"))h.value=x.get("iter");else{const{iter:e}=i();e&&(h.value=e)}async function y(){try{f.classList.add("is-loading"),m.replaceChildren();const e=function(e,t,n){let a="0";try{const e=String(t).replace(/\D+/g,"");a=String(BigInt(e||"0"))}catch{}const o=0|Math.max(0,Number(n||0)),i=document.createElementNS(r,"svg");i.setAttribute("xmlns",r);const l=document.createElementNS(r,"script");return l.setAttribute("type","application/javascript"),l.textContent=`\n         (() => {\n         // local scope: no globals leak between renders\n         const SEED = ${a}n;\n         function splitmix64(n0){let n=n0;return function(){\n            let z=n = (n + 0x9e3779b97f4a7c15n) & 0xffffffffffffffffn;\n            z = (z ^ (z >> 30n)) * 0xbf58476d1ce4e5b9n & 0xffffffffffffffffn;\n            z = (z ^ (z >> 27n)) * 0x94d049bb133111ebn & 0xffffffffffffffffn;\n            return Number((z ^ (z >> 31n)) & 0xffffffffn) >>> 0;\n         }}\n         function sfc32(a,b,c,d){ return function(){\n            d|=0; let t = (a|=0) + (b|=0) | 0; t = (t + (d|=0)) | 0;\n            d = (d + 1) | 0; a = b ^ (b>>>9); b = (c + (c<<3)) | 0;\n            c = ((c<<21) | (c>>>11)); c = (c + t) | 0;\n            return ((t>>>0) / 4294967296);\n         }; }\n\n         const sm = splitmix64(SEED), a=sm(), b=sm(), c=sm(), d=sm();\n         const n = ${o};\n\n         // ⬇️ key change: bind to the actual <svg>\n         const svgEl =\n            (document.currentScript && document.currentScript.ownerSVGElement) ||\n            (typeof document !== 'undefined' && document.querySelector('#stage > svg')) ||\n            null;\n\n         const BTLDR = {\n            rnd: sfc32(a,b,c,d),\n            seed: SEED,\n            iterationNumber: n,\n            isPreview: (n===0 && SEED===0n),\n            svg: svgEl,               // ⬅️ not document.documentElement\n            v: 'svg-js:0.0.1'\n         };\n\n         (function(BTLDR){\n            ${e}\n         })(BTLDR);\n         })();\n         `.trim(),i.appendChild(l),i}(await c(),g.value,h.value);m.appendChild(e),requestAnimationFrame(w)}catch(e){w();const t=document.createElement("pre");t.style.cssText="color:#333;background:#fafafa;padding:16px;margin:0;white-space:pre-wrap;overflow:auto;",t.textContent=String(e),m.replaceChildren(t),console.error(e)}}s(g),s(h);const S=function(e,t=250){let n;return(...a)=>{clearTimeout(n),n=setTimeout(()=>e(...a),t)}}(y,250);v.addEventListener("click",()=>{l(g.value,h.value),y()}),b.addEventListener("click",()=>{const e=Math.floor(1e5+9e5*Math.random()).toString();g.value=e,l(g.value,h.value),y()}),h.addEventListener("input",()=>{""!==h.value&&(h.value=String(Math.max(0,Math.floor(Number(h.value))))),l(g.value,h.value),s(h),S()}),g.addEventListener("input",()=>{g.value=g.value.replace(/\D+/g,"").slice(0,6),l(g.value,h.value),s(g),S()}),p.querySelectorAll(".clearbtn").forEach(e=>{e.addEventListener("click",()=>{const r=e.getAttribute("data-target"),o=p.querySelector("#"+r);var i;o&&(o.value="0",i="seed"===r?"seed":"iter",t&&("seed"===i&&localStorage.removeItem(n),"iter"===i&&localStorage.removeItem(a)),s(o),l(g.value,h.value),S(),o.focus())})}),window.BootloaderSandbox={render:y,get seed(){return g.value},set seed(e){g.value=String(e||0),l(g.value,h.value),S()},get iter(){return h.value},set iter(e){h.value=String(Math.max(0,Math.floor(Number(e||0)))),l(g.value,h.value),S()}},y()}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",u,{once:!0}):u()})();
